<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ephyspy.features.sweep_features &mdash; EphysPy 0.0.05 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=ecdf1fa4"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            EphysPy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">ephyspy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">EphysPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ephyspy.features.sweep_features</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ephyspy.features.sweep_features</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Copyright 2023 Jonas Beck</span>

<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>

<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>

<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">Axes</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ndarray</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">cumulative_trapezoid</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

<span class="kn">import</span> <span class="nn">ephyspy.allen_sdk.ephys_features</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">from</span> <span class="nn">ephyspy.features.base</span> <span class="kn">import</span> <span class="n">SweepFeature</span>
<span class="kn">from</span> <span class="nn">ephyspy.features.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FeatureError</span><span class="p">,</span>
    <span class="n">fetch_available_fts</span><span class="p">,</span>
    <span class="n">get_sweep_burst_metrics</span><span class="p">,</span>
    <span class="n">get_sweep_sag_idxs</span><span class="p">,</span>
    <span class="n">has_rebound</span><span class="p">,</span>
    <span class="n">has_spikes</span><span class="p">,</span>
    <span class="n">has_stimulus</span><span class="p">,</span>
    <span class="n">is_hyperpol</span><span class="p">,</span>
    <span class="n">median_idx</span><span class="p">,</span>
    <span class="n">where_stimulus</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ephyspy.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">is_sweep_feature</span><span class="p">,</span>
    <span class="n">parse_desc</span><span class="p">,</span>
    <span class="n">relabel_line</span><span class="p">,</span>
    <span class="n">unpack</span><span class="p">,</span>
    <span class="n">where_between</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="available_sweep_features"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.available_sweep_features">[docs]</a><span class="k">def</span> <span class="nf">available_sweep_features</span><span class="p">(</span>
    <span class="n">compute_at_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SweepFeature</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a dictionary of all implemented sweep features.</span>

<span class="sd">    Looks for all classes that inherit from SweepFeature and returns a dictionary</span>
<span class="sd">    of all available features. If compute_at_init is True, the features are</span>
<span class="sd">    computed at initialization.</span>

<span class="sd">    Args:</span>
<span class="sd">        compute_at_init (bool, optional): If True, the features are computed at</span>
<span class="sd">            initialization. Defaults to False.</span>
<span class="sd">        store_diagnostics (bool, optional): If True, the features are computed</span>
<span class="sd">            with diagnostics. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, SweepFeature]: Dictionary of all available spike features.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_features</span> <span class="o">=</span> <span class="n">fetch_available_fts</span><span class="p">()</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="n">ft</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">ft</span> <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">all_features</span> <span class="k">if</span> <span class="n">is_sweep_feature</span><span class="p">(</span><span class="n">ft</span><span class="p">)}</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;sweep_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">compute_at_init</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">v</span><span class="p">(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                <span class="n">compute_at_init</span><span class="o">=</span><span class="n">compute_at_init</span><span class="p">,</span>
                <span class="n">store_diagnostics</span><span class="o">=</span><span class="n">store_diagnostics</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">features</span></div>


<div class="viewcode-block" id="NullSweepFeature"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.NullSweepFeature">[docs]</a><span class="k">class</span> <span class="nc">NullSweepFeature</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dummy sweep level feature.</span>

<span class="sd">    Dummy feature that can be used as a placeholder to compute sweepset level</span>
<span class="sd">    features using `SweepSetFeature` if no sweep level feature for it is available.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: Only the corresponding sweepset level feature exsits.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Sweep_Stim_amp"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Stim_amp">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Stim_amp</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level stimulus ampltiude feature.</span>
<span class="sd">    depends on: /.</span>
<span class="sd">    description: maximum amplitude of stimulus.</span>
<span class="sd">    units: pA.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">({</span><span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">]})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">i_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">i_amp</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Stim_onset"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Stim_onset">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Stim_onset</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level stimulus onset feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: time of stimulus onset.</span>
<span class="sd">    units: s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">stim_onset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">where_stim</span> <span class="o">=</span> <span class="n">where_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">stim_onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_stim</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">i_onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="n">where_stim</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">idx_onset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">where_stim</span><span class="p">))[</span><span class="n">where_stim</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;i_onset&quot;</span><span class="p">:</span> <span class="n">i_onset</span><span class="p">,</span>
                        <span class="s2">&quot;where_stim&quot;</span><span class="p">:</span> <span class="n">where_stim</span><span class="p">,</span>
                        <span class="s2">&quot;idx_onset&quot;</span><span class="p">:</span> <span class="n">idx_onset</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">stim_onset</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="n">i_onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;i_onset&quot;</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">onset</span><span class="p">,</span> <span class="n">i_onset</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Stim_end"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Stim_end">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Stim_end</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level stimulus end feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: time of stimulus end.</span>
<span class="sd">    units: s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">stim_end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">where_stim</span> <span class="o">=</span> <span class="n">where_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">stim_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_stim</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">i_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="n">where_stim</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">idx_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">where_stim</span><span class="p">))[</span><span class="n">where_stim</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;i_end&quot;</span><span class="p">:</span> <span class="n">i_end</span><span class="p">,</span> <span class="s2">&quot;where_stim&quot;</span><span class="p">:</span> <span class="n">where_stim</span><span class="p">,</span> <span class="s2">&quot;idx_end&quot;</span><span class="p">:</span> <span class="n">idx_end</span><span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">stim_end</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="n">i_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;i_end&quot;</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">i_end</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Num_AP"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Num_AP">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Num_AP</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level spike count feature.</span>

<span class="sd">    depends on: stim_onset, stim_end.</span>
<span class="sd">    description: # peaks during stimulus.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">peak_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_t&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_onset&quot;</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">)</span>
        <span class="n">stim_window</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">peak_t</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="n">peak_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_index&quot;</span><span class="p">)[</span><span class="n">stim_window</span><span class="p">]</span>
        <span class="n">num_ap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_ap</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_ap</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
            <span class="n">peak_t</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="n">stim_window</span><span class="p">]</span>
            <span class="n">peak_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_v&quot;</span><span class="p">)[</span><span class="n">stim_window</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;peak_i&quot;</span><span class="p">:</span> <span class="n">peak_i</span><span class="p">,</span>
                    <span class="s2">&quot;peak_t&quot;</span><span class="p">:</span> <span class="n">peak_t</span><span class="p">,</span>
                    <span class="s2">&quot;peak_v&quot;</span><span class="p">:</span> <span class="n">peak_v</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">num_ap</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">peak_t</span><span class="p">,</span> <span class="n">peak_v</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;peak_t&quot;</span><span class="p">,</span> <span class="s2">&quot;peak_v&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_t</span><span class="p">,</span> <span class="n">peak_v</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_AP_freq"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_freq">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_freq</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level spike rate feature.</span>

<span class="sd">    depends on: numap.</span>
<span class="sd">    description: # peaks during stimulus / stimulus duration.</span>
<span class="sd">    units: Hz.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">num_ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;num_ap&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_onset&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>

        <span class="n">ap_freq</span> <span class="o">=</span> <span class="n">num_ap</span> <span class="o">/</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">onset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;ap_freq&quot;</span><span class="p">:</span> <span class="n">ap_freq</span><span class="p">,</span> <span class="s2">&quot;num_ap&quot;</span><span class="p">:</span> <span class="n">num_ap</span><span class="p">,</span> <span class="s2">&quot;onset&quot;</span><span class="p">:</span> <span class="n">onset</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ap_freq</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">num_ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;num_ap&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">num_ap</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_AP_latency"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_latency">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_latency</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level ap_latency feature.</span>

<span class="sd">    depends on: stim_onset.</span>
<span class="sd">    description: time of first spike after stimulus onset.</span>
<span class="sd">    units: s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ap_latency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_onset&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">thresh_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;threshold_t&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;threshold_v&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">stim_window</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">thresh_t</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

            <span class="n">thresh_t_stim</span> <span class="o">=</span> <span class="n">thresh_t</span><span class="p">[</span><span class="n">stim_window</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresh_t_stim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">v_first_spike</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">stim_window</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">t_first_spike</span> <span class="o">=</span> <span class="n">thresh_t_stim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ap_latency</span> <span class="o">=</span> <span class="n">t_first_spike</span> <span class="o">-</span> <span class="n">onset</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;onset&quot;</span><span class="p">:</span> <span class="n">onset</span><span class="p">,</span>
                            <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
                            <span class="s2">&quot;spike_times_during_stim&quot;</span><span class="p">:</span> <span class="n">thresh_t_stim</span><span class="p">,</span>
                            <span class="s2">&quot;t_first&quot;</span><span class="p">:</span> <span class="n">t_first_spike</span><span class="p">,</span>
                            <span class="s2">&quot;v_first&quot;</span><span class="p">:</span> <span class="n">v_first_spike</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">ap_latency</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">v_first</span><span class="p">,</span> <span class="n">t_first</span><span class="p">,</span> <span class="n">onset</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;v_first&quot;</span><span class="p">,</span> <span class="s2">&quot;t_first&quot;</span><span class="p">,</span> <span class="s2">&quot;onset&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">v_first</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">t_first</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_V_baseline"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_V_baseline">[docs]</a><span class="k">class</span> <span class="nc">Sweep_V_baseline</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level baseline voltage feature.</span>

<span class="sd">    depends on: stim_onset.</span>
<span class="sd">    description: average voltage in baseline_interval (in s) before stimulus onset.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">v_baseline_avg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_onset&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">onset</span><span class="p">):</span>
            <span class="n">baseline_interval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
            <span class="n">where_baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>  <span class="c1"># for I=0pA</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">baseline_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">baseline_interval</span>
            <span class="n">where_baseline</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">onset</span> <span class="o">-</span> <span class="n">baseline_interval</span><span class="p">,</span> <span class="n">onset</span>
            <span class="p">)</span>
        <span class="n">t_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_baseline</span><span class="p">]</span>
        <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">where_baseline</span><span class="p">]</span>
        <span class="n">v_baseline_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v_baseline</span><span class="p">)</span>
        <span class="c1"># v_baseline_avg = sweep._get_baseline_voltage() # bad since start is set to t[0]</span>
        <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;where_baseline&quot;</span><span class="p">:</span> <span class="n">where_baseline</span><span class="p">,</span>
                    <span class="s2">&quot;t_baseline&quot;</span><span class="p">:</span> <span class="n">t_baseline</span><span class="p">,</span>
                    <span class="s2">&quot;v_baseline&quot;</span><span class="p">:</span> <span class="n">v_baseline</span><span class="p">,</span>
                    <span class="s2">&quot;baseline_interval&quot;</span><span class="p">:</span> <span class="n">baseline_interval</span><span class="p">,</span>
                    <span class="s2">&quot;stim_onset&quot;</span><span class="p">:</span> <span class="n">onset</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">v_baseline_avg</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t_base</span><span class="p">,</span> <span class="n">v_base</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_baseline&quot;</span><span class="p">,</span> <span class="s2">&quot;v_baseline&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_base</span><span class="p">,</span> <span class="n">v_base</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; interval&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_V_deflect"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_V_deflect">[docs]</a><span class="k">class</span> <span class="nc">Sweep_V_deflect</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level voltage deflection feature.</span>

<span class="sd">    depends on: stim_end.</span>
<span class="sd">    description: average voltage during last 100 ms of stimulus.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">v_deflect_avg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># v_deflect_avg = self.data.voltage_deflection()[0]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">v_deflect_avg</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">average_voltage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">end</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span>
            <span class="p">)</span>
            <span class="n">idx_deflect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">where_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">end</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">t_deflect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_deflect</span><span class="p">]</span>
            <span class="n">v_deflect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">idx_deflect</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;idx_deflect&quot;</span><span class="p">:</span> <span class="n">idx_deflect</span><span class="p">,</span>
                        <span class="s2">&quot;t_deflect&quot;</span><span class="p">:</span> <span class="n">t_deflect</span><span class="p">,</span>
                        <span class="s2">&quot;v_deflect&quot;</span><span class="p">:</span> <span class="n">v_deflect</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">v_deflect_avg</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t_deflect</span><span class="p">,</span> <span class="n">v_deflect</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_deflect&quot;</span><span class="p">,</span> <span class="s2">&quot;v_deflect&quot;</span><span class="p">])</span>
        <span class="n">t_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">t_deflect</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_deflect</span><span class="p">,</span> <span class="n">v_deflect</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; interval&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_deflect</span><span class="p">,</span> <span class="n">t_bar</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Tau"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Tau">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Tau</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level time constant feature.</span>

<span class="sd">    depends on: v_baseline, stim_onset.</span>
<span class="sd">    description: time constant of exponential fit to voltage deflection.</span>
<span class="sd">    units: s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;The following code block is copied and adapted from sweep.estimate_time_constant().&quot;&quot;&quot;</span>
            <span class="n">v_peak</span><span class="p">,</span> <span class="n">peak_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">voltage_deflection</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>
            <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">5</span> <span class="o">&lt;</span> <span class="n">v_baseline</span> <span class="o">-</span> <span class="n">v_peak</span><span class="p">:</span>
                <span class="n">stim_onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span>
                    <span class="s2">&quot;stim_onset&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span>
                <span class="p">)</span>
                <span class="n">onset_idx</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">find_time_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">)</span>

                <span class="n">frac</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">search_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">onset_idx</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">frac</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_peak</span> <span class="o">-</span> <span class="n">v_baseline</span><span class="p">)</span> <span class="o">+</span> <span class="n">v_baseline</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">search_result</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FeatureError</span><span class="p">(</span>
                        <span class="s2">&quot;could not find interval for time constant estimate&quot;</span>
                    <span class="p">)</span>

                <span class="n">fit_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">search_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">onset_idx</span><span class="p">]</span>
                <span class="n">fit_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">peak_index</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">peak_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">200</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;A DOWNWARD PEAK WAS OBSERVED GOING TO LESS THAN 200 MV!!!&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># Look for another local minimum closer to stimulus onset</span>
                    <span class="c1"># We look for a couple of milliseconds after stimulus onset to 50 ms before the downward peak</span>
                    <span class="n">end_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">onset_idx</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">onset_idx</span> <span class="o">+</span> <span class="mi">50</span> <span class="p">:</span> <span class="n">peak_index</span> <span class="o">-</span> <span class="mi">1250</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">fit_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">end_index</span><span class="p">]</span>
                    <span class="n">fit_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">onset_idx</span> <span class="o">+</span> <span class="mi">50</span><span class="p">]</span>

                <span class="n">a</span><span class="p">,</span> <span class="n">inv_tau</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">fit_membrane_time_constant</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">fit_start</span><span class="p">,</span> <span class="n">fit_end</span>
                <span class="p">)</span>

                <span class="n">tau</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">inv_tau</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
                            <span class="s2">&quot;inv_tau&quot;</span><span class="p">:</span> <span class="n">inv_tau</span><span class="p">,</span>
                            <span class="s2">&quot;y0&quot;</span><span class="p">:</span> <span class="n">y0</span><span class="p">,</span>
                            <span class="s2">&quot;fit_start&quot;</span><span class="p">:</span> <span class="n">fit_start</span><span class="p">,</span>
                            <span class="s2">&quot;fit_end&quot;</span><span class="p">:</span> <span class="n">fit_end</span><span class="p">,</span>
                            <span class="s2">&quot;equation&quot;</span><span class="p">:</span> <span class="s2">&quot;y0 + a * exp(-inv_tau * x)&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">tau</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">y0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">inv_tau</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;y0&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;inv_tau&quot;</span><span class="p">])</span>
        <span class="n">fit_start</span><span class="p">,</span> <span class="n">fit_end</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;fit_start&quot;</span><span class="p">,</span> <span class="s2">&quot;fit_end&quot;</span><span class="p">])</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span>

        <span class="n">y</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">inv_tau</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>

        <span class="n">where_fit</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fit_start</span><span class="p">,</span> <span class="n">fit_end</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">where_fit</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="n">where_fit</span><span class="p">]</span>
        <span class="n">t_offset</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t_fit</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">t_offset</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; interval&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">(</span><span class="n">t_fit</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; fit&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_AP_freq_adapt"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_freq_adapt">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_freq_adapt</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level spike frequency adaptation feature.</span>

<span class="sd">    depends on: stim_onset, stim_end, num_ap.</span>
<span class="sd">    description: ratio of spikes in second and first half half of stimulus interval, if there is at least 5 spikes in total.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ap_freq_adapt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="n">num_ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;num_ap&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_ap</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">has_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_onset&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">t_half</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">onset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">onset</span>
            <span class="n">where_1st_half</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">t_half</span><span class="p">)</span>
            <span class="n">where_2nd_half</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">t_half</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">t_1st_half</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_1st_half</span><span class="p">]</span>
            <span class="n">t_2nd_half</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_2nd_half</span><span class="p">]</span>

            <span class="n">peak_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_t&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_onset&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">stim_window</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">peak_t</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">peak_t</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="n">stim_window</span><span class="p">]</span>

            <span class="n">spikes_1st_half</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="n">peak_t</span> <span class="o">&lt;</span> <span class="n">t_half</span><span class="p">]</span>
            <span class="n">spikes_2nd_half</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="n">peak_t</span> <span class="o">&gt;</span> <span class="n">t_half</span><span class="p">]</span>
            <span class="n">num_spikes_1st_half</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes_1st_half</span><span class="p">)</span>
            <span class="n">num_spikes_2nd_half</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes_2nd_half</span><span class="p">)</span>
            <span class="n">ap_freq_adapt</span> <span class="o">=</span> <span class="n">num_spikes_2nd_half</span> <span class="o">/</span> <span class="n">num_spikes_1st_half</span>

            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;num_spikes_1st_half&quot;</span><span class="p">:</span> <span class="n">num_spikes_1st_half</span><span class="p">,</span>
                        <span class="s2">&quot;num_spikes_2nd_half&quot;</span><span class="p">:</span> <span class="n">num_spikes_2nd_half</span><span class="p">,</span>
                        <span class="s2">&quot;where_1st_half&quot;</span><span class="p">:</span> <span class="n">where_1st_half</span><span class="p">,</span>
                        <span class="s2">&quot;where_2nd_half&quot;</span><span class="p">:</span> <span class="n">where_2nd_half</span><span class="p">,</span>
                        <span class="s2">&quot;t_1st_half&quot;</span><span class="p">:</span> <span class="n">t_1st_half</span><span class="p">,</span>
                        <span class="s2">&quot;t_2nd_half&quot;</span><span class="p">:</span> <span class="n">t_2nd_half</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">ap_freq_adapt</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">num_ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;num_ap&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">peaks_t</span><span class="p">,</span> <span class="n">peaks_v</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">num_ap</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;peak_t&quot;</span><span class="p">,</span> <span class="s2">&quot;peak_v&quot;</span><span class="p">])</span>
        <span class="n">half1</span><span class="p">,</span> <span class="n">half2</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_1st_half&quot;</span><span class="p">,</span> <span class="s2">&quot;t_2nd_half&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">half</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">half1</span><span class="p">,</span> <span class="n">half2</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">])):</span>
            <span class="n">in_half</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">peaks_t</span><span class="p">,</span> <span class="o">*</span><span class="n">half</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peaks_t</span><span class="p">[</span><span class="n">in_half</span><span class="p">],</span> <span class="n">peaks_v</span><span class="p">[</span><span class="n">in_half</span><span class="p">],</span> <span class="n">m</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/2&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_AP_amp_slope"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_amp_slope">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_amp_slope</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level spike count feature.</span>

<span class="sd">    depends on: stim_onset, stim_end.</span>
<span class="sd">    description: spike amplitude adaptation as the slope of a linear fit v_peak(t_peak)</span>
<span class="sd">    during the stimulus interval.</span>
<span class="sd">    units: mV/s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ap_amp_slope</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_onset&quot;</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">)</span>
        <span class="n">peak_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_t&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="n">peak_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_v&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="n">stim_window</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">peak_t</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="n">peak_t</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="n">stim_window</span><span class="p">]</span>
        <span class="n">peak_v</span> <span class="o">=</span> <span class="n">peak_v</span><span class="p">[</span><span class="n">stim_window</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">m</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>
            <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">e</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">peak_t</span><span class="p">,</span> <span class="n">peak_v</span><span class="p">)</span>

            <span class="n">ap_amp_slope</span> <span class="o">=</span> <span class="n">m</span>
            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;peak_t&quot;</span><span class="p">:</span> <span class="n">peak_t</span><span class="p">,</span>
                        <span class="s2">&quot;peak_v&quot;</span><span class="p">:</span> <span class="n">peak_v</span><span class="p">,</span>
                        <span class="s2">&quot;slope&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
                        <span class="s2">&quot;intercept&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">ap_amp_slope</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">intercept</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">peak_t</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">,</span> <span class="s2">&quot;slope&quot;</span><span class="p">,</span> <span class="s2">&quot;peak_t&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">t</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">peak_t</span>  <span class="c1"># or ts = self.data.t</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">y</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_ISI_FF"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_ISI_FF">[docs]</a><span class="k">class</span> <span class="nc">Sweep_ISI_FF</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level inter-spike-interval (ISI) Fano factor feature.</span>

<span class="sd">    depends on: ISIs.</span>
<span class="sd">    description: Var(ISIs) / Mean(ISIs).</span>
<span class="sd">    units: s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">isi_ff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_spikes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">isi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;isi&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">isi_ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">isi</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">isi</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;isi&quot;</span><span class="p">:</span> <span class="n">isi</span><span class="p">,</span>
                            <span class="s2">&quot;isi_var&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">isi</span><span class="p">),</span>
                            <span class="s2">&quot;isi_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">isi</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">isi_ff</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> plotting not implemented.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_ISI_CV"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_ISI_CV">[docs]</a><span class="k">class</span> <span class="nc">Sweep_ISI_CV</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level inter-spike-interval (ISI) coefficient of variation (CV) feature.</span>

<span class="sd">    depends on: ISIs.</span>
<span class="sd">    description: Std(ISIs) / Mean(ISIs).</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">isi_cv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_spikes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">isi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;isi&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">isi_cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">isi</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">isi</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;isi&quot;</span><span class="p">:</span> <span class="n">isi</span><span class="p">,</span>
                            <span class="s2">&quot;isi_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">isi</span><span class="p">),</span>
                            <span class="s2">&quot;isi_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">isi</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">isi_cv</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> plotting not implemented.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_AP_FF"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_FF">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_FF</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level AP amplitude Fano factor feature.</span>

<span class="sd">    depends on: ap_amp.</span>
<span class="sd">    description: Var(ap_amp) / Mean(ap_amp).</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ap_ff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_spikes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">ap_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;ap_amp&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ap_ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;ap_amp&quot;</span><span class="p">:</span> <span class="n">ap_amp</span><span class="p">,</span>
                            <span class="s2">&quot;ap_amp_var&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">),</span>
                            <span class="s2">&quot;ap_amp_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">ap_ff</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> plotting not implemented.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_AP_CV"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_CV">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_CV</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level AP amplitude coefficient of variation (CV) feature.</span>

<span class="sd">    depends on: ap_amp.</span>
<span class="sd">    description: Std(ap_amp) / Mean(ap_amp).</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ap_cv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_spikes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">ap_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;ap_amp&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ap_cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;ap_amp&quot;</span><span class="p">:</span> <span class="n">ap_amp</span><span class="p">,</span>
                            <span class="s2">&quot;ap_amp_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">),</span>
                            <span class="s2">&quot;ap_amp_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">ap_cv</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> plotting not implemented.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_R_input"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_R_input">[docs]</a><span class="k">class</span> <span class="nc">Sweep_R_input</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level input resistance feature.</span>

<span class="sd">    depends on: stim_amp, v_deflect, v_baseline.</span>
<span class="sd">    description: sweep level input resistance as (v_deflect - v_baseline / current).</span>
<span class="sd">    Should not be used for cell level feature.</span>
<span class="sd">    units: MOhm.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">r_input</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">stim_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_amp&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">v_deflect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_deflect&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">r_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">v_deflect</span> <span class="o">-</span> <span class="n">v_baseline</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">stim_amp</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;v_baseline&quot;</span><span class="p">:</span> <span class="n">v_baseline</span><span class="p">,</span>
                        <span class="s2">&quot;v_deflect&quot;</span><span class="p">:</span> <span class="n">v_deflect</span><span class="p">,</span>
                        <span class="s2">&quot;stim_amp&quot;</span><span class="p">:</span> <span class="n">stim_amp</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">r_input</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> plotting not implemented.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_V_sag"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_V_sag">[docs]</a><span class="k">class</span> <span class="nc">Sweep_V_sag</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level sag voltage feature.</span>

<span class="sd">    depends on: v_deflect, v_baseline.</span>
<span class="sd">    description: Average voltage around max deflection.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">peak_width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_width</span> <span class="o">=</span> <span class="n">peak_width</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of peak_width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">v_sag</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">where_sag</span> <span class="o">=</span> <span class="n">get_sweep_sag_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="n">store_diagnostics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">where_sag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># TODO: what should be min sag duration!?</span>
                <span class="c1"># The following can also be found in sweep.estimate_sag()</span>
                <span class="n">v_deflect</span><span class="p">,</span> <span class="n">idx_deflect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">voltage_deflection</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">idx_deflect</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">200</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Downward peak &lt; 200 mV&quot;</span><span class="p">)</span>
                    <span class="c1"># Look for another local minimum closer to stimulus onset</span>
                    <span class="n">idx_deflect</span> <span class="o">-=</span> <span class="n">ft</span><span class="o">.</span><span class="n">find_time_index</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.12</span>
                    <span class="p">)</span> <span class="o">-</span> <span class="n">ft</span><span class="o">.</span><span class="n">find_time_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

                <span class="n">t_deflect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_deflect</span><span class="p">]</span>
                <span class="n">stim_onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span>
                    <span class="s2">&quot;stim_onset&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span>
                <span class="p">)</span>
                <span class="n">stim_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>  <span class="c1"># TODO: Check if stricter criterion is sensible, i.e. t_deflect &lt; t_half_stim</span>
                    <span class="n">stim_onset</span> <span class="o">&lt;</span> <span class="n">t_deflect</span> <span class="o">&lt;</span> <span class="n">stim_end</span>
                <span class="p">):</span>  <span class="c1"># in some rare cases this is not the case</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">t_deflect</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_width</span> <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">t_deflect</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_width</span> <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="n">v_sag</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">average_voltage</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                        <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                        <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;where_sag&quot;</span><span class="p">:</span> <span class="n">where_sag</span><span class="p">,</span>
                                <span class="s2">&quot;v_deflect&quot;</span><span class="p">:</span> <span class="n">v_deflect</span><span class="p">,</span>
                                <span class="s2">&quot;idx_deflect&quot;</span><span class="p">:</span> <span class="n">idx_deflect</span><span class="p">,</span>
                                <span class="s2">&quot;t_deflect&quot;</span><span class="p">:</span> <span class="n">t_deflect</span><span class="p">,</span>
                                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
        <span class="k">return</span> <span class="n">v_sag</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Sag"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Sag">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Sag</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level sag feature.</span>

<span class="sd">    depends on: v_sag.</span>
<span class="sd">    description: magnitude of the depolarization peak.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">peak_width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_width</span> <span class="o">=</span> <span class="n">peak_width</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of peak_width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sag</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">where_sag</span> <span class="o">=</span> <span class="n">get_sweep_sag_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="n">store_diagnostics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">where_sag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># TODO: what should be min sag duration!?</span>
                <span class="n">v_sag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_sag&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
                <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span>
                    <span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span>
                <span class="p">)</span>
                <span class="n">sag</span> <span class="o">=</span> <span class="n">v_sag</span> <span class="o">-</span> <span class="n">v_baseline</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;v_sag&quot;</span><span class="p">:</span> <span class="n">v_sag</span><span class="p">,</span>
                            <span class="s2">&quot;where_sag&quot;</span><span class="p">:</span> <span class="n">where_sag</span><span class="p">,</span>
                            <span class="s2">&quot;v_baseline&quot;</span><span class="p">:</span> <span class="n">v_baseline</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">sag</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">v_baseline</span><span class="p">,</span> <span class="n">v_sag</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="s2">&quot;v_sag&quot;</span><span class="p">])</span>
        <span class="n">sag_voltage_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_sag&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">t_deflect</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">sag_voltage_ft</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_deflect&quot;</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">t_deflect</span><span class="p">,</span> <span class="n">v_baseline</span><span class="p">,</span> <span class="n">v_sag</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sag&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_V_steady"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_V_steady">[docs]</a><span class="k">class</span> <span class="nc">Sweep_V_steady</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level hyperpol steady state feature.</span>

<span class="sd">    depends on: stim_end.</span>
<span class="sd">    description: hyperpol steady state voltage.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">v_steady</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">stim_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">stim_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">baseline_interval</span>
            <span class="n">v_steady</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">average_voltage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                <span class="n">end</span><span class="o">=</span><span class="n">stim_end</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">({</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">stim_end</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">v_steady</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Sag_fraction"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Sag_fraction">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Sag_fraction</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level sag fraction feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: fraction that membrane potential relaxes back to baseline.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">peak_width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_width</span> <span class="o">=</span> <span class="n">peak_width</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of peak_width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sag_fraction</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">where_sag</span> <span class="o">=</span> <span class="n">get_sweep_sag_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="n">store_diagnostics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">where_sag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># TODO: what should be min sag duration!?</span>
                <span class="n">sag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;sag&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
                <span class="n">v_sag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_sag&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
                <span class="n">v_steady</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_steady&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>

                <span class="n">sag_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_sag</span> <span class="o">-</span> <span class="n">v_steady</span><span class="p">)</span> <span class="o">/</span> <span class="n">sag</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;sag&quot;</span><span class="p">:</span> <span class="n">sag</span><span class="p">,</span>
                            <span class="s2">&quot;v_sag&quot;</span><span class="p">:</span> <span class="n">v_sag</span><span class="p">,</span>
                            <span class="s2">&quot;where_sag&quot;</span><span class="p">:</span> <span class="n">where_sag</span><span class="p">,</span>
                            <span class="s2">&quot;v_steady&quot;</span><span class="p">:</span> <span class="n">v_steady</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">sag_fraction</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">sag_v_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_sag&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">t_deflect</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">sag_v_ft</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="s2">&quot;t_deflect&quot;</span><span class="p">)</span>
        <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">)</span>
        <span class="n">stim_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">)</span>
        <span class="n">v_sag</span><span class="p">,</span> <span class="n">v_steady</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;v_sag&quot;</span><span class="p">,</span> <span class="s2">&quot;v_steady&quot;</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">t_deflect</span><span class="p">,</span> <span class="n">v_baseline</span><span class="p">,</span> <span class="n">v_sag</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sag&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">stim_end</span><span class="p">,</span> <span class="n">v_steady</span><span class="p">,</span> <span class="n">v_sag</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;v_sag - v_steady&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Sag_ratio"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Sag_ratio">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Sag_ratio</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level sag ratio feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: ratio of steady state voltage decrease to the largest voltage decrease.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sag_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">where_sag</span> <span class="o">=</span> <span class="n">get_sweep_sag_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="n">store_diagnostics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">where_sag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># TODO: what should be min sag duration!?</span>
                <span class="n">sag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;sag&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
                <span class="n">v_steady</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_steady&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
                <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span>
                    <span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span>
                <span class="p">)</span>

                <span class="n">sag_ratio</span> <span class="o">=</span> <span class="n">sag</span> <span class="o">/</span> <span class="p">(</span><span class="n">v_steady</span> <span class="o">-</span> <span class="n">v_baseline</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;sag&quot;</span><span class="p">:</span> <span class="n">sag</span><span class="p">,</span>
                            <span class="s2">&quot;where_sag&quot;</span><span class="p">:</span> <span class="n">where_sag</span><span class="p">,</span>
                            <span class="s2">&quot;v_baseline&quot;</span><span class="p">:</span> <span class="n">v_baseline</span><span class="p">,</span>
                            <span class="s2">&quot;v_steady&quot;</span><span class="p">:</span> <span class="n">v_steady</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">sag_ratio</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">sag_v_ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_sag&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">t_deflect</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">sag_v_ft</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="s2">&quot;t_deflect&quot;</span><span class="p">)</span>
        <span class="n">v_sag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_sag&quot;</span><span class="p">)</span>
        <span class="n">stim_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">)</span>
        <span class="n">v_baseline</span><span class="p">,</span> <span class="n">v_steady</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="s2">&quot;v_steady&quot;</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">stim_end</span><span class="p">,</span> <span class="n">v_steady</span><span class="p">,</span> <span class="n">v_baseline</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;v_steady - v_base&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">t_deflect</span><span class="p">,</span> <span class="n">v_baseline</span><span class="p">,</span> <span class="n">v_sag</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sag&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Sag_area"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Sag_area">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Sag_area</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level sag area feature.</span>

<span class="sd">    depends on: v_deflect, stim_onset, stim_end.</span>
<span class="sd">    description: area under the sag.</span>
<span class="sd">    units: mV*s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sag_area</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">where_sag</span> <span class="o">=</span> <span class="n">get_sweep_sag_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="n">store_diagnostics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">where_sag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># TODO: what should be min sag duration!?</span>
                <span class="n">v_sag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">where_sag</span><span class="p">]</span>
                <span class="n">t_sag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_sag</span><span class="p">]</span>
                <span class="n">v_sagline</span> <span class="o">=</span> <span class="n">v_sag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Take running average of v?</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_sag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># at least 10 points to integrate</span>
                    <span class="n">sag_area</span> <span class="o">=</span> <span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">v_sagline</span> <span class="o">-</span> <span class="n">v_sag</span><span class="p">,</span> <span class="n">t_sag</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;where_sag&quot;</span><span class="p">:</span> <span class="n">where_sag</span><span class="p">,</span>
                                <span class="s2">&quot;v_sag&quot;</span><span class="p">:</span> <span class="n">v_sag</span><span class="p">,</span>
                                <span class="s2">&quot;t_sag&quot;</span><span class="p">:</span> <span class="n">t_sag</span><span class="p">,</span>
                                <span class="s2">&quot;v_sagline&quot;</span><span class="p">:</span> <span class="n">v_sagline</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">sag_area</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t_sag</span><span class="p">,</span> <span class="n">v_sag</span><span class="p">,</span> <span class="n">v_sagline</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_sag&quot;</span><span class="p">,</span> <span class="s2">&quot;v_sag&quot;</span><span class="p">,</span> <span class="s2">&quot;v_sagline&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_sag</span><span class="p">,</span> <span class="n">v_sag</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sag interval&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">t_sag</span><span class="p">,</span> <span class="n">v_sag</span><span class="p">,</span> <span class="n">v_sagline</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Sag_time"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Sag_time">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Sag_time</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level sag duration feature.</span>

<span class="sd">    depends on: v_deflect, stim_onset, stim_end.</span>
<span class="sd">    description: duration of the sag.</span>
<span class="sd">    units: s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sag_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">where_sag</span> <span class="o">=</span> <span class="n">get_sweep_sag_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="n">store_diagnostics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">where_sag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># TODO: what should be min sag duration!?</span>
                <span class="n">sag_t_start</span><span class="p">,</span> <span class="n">sag_t_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_sag</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">sag_time</span> <span class="o">=</span> <span class="n">sag_t_end</span> <span class="o">-</span> <span class="n">sag_t_start</span>
                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;where_sag&quot;</span><span class="p">:</span> <span class="n">where_sag</span><span class="p">,</span>
                            <span class="s2">&quot;sag_t_start&quot;</span><span class="p">:</span> <span class="n">sag_t_start</span><span class="p">,</span>
                            <span class="s2">&quot;sag_t_end&quot;</span><span class="p">:</span> <span class="n">sag_t_end</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">sag_time</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">where_sag</span><span class="p">,</span> <span class="n">sag_start</span><span class="p">,</span> <span class="n">sag_end</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;where_sag&quot;</span><span class="p">,</span> <span class="s2">&quot;sag_t_start&quot;</span><span class="p">,</span> <span class="s2">&quot;sag_t_end&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">where_sag</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">sag_start</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">sag_end</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_V_plateau"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_V_plateau">[docs]</a><span class="k">class</span> <span class="nc">Sweep_V_plateau</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level plataeu voltage feature.</span>

<span class="sd">    depends on: stim_end.</span>
<span class="sd">    description: average voltage during the plateau.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">T_plateau</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_plateau</span> <span class="o">=</span> <span class="n">T_plateau</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of T_plateau</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">v_avg_plateau</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hyperpol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="c1"># same as voltage deflection</span>
            <span class="n">where_plateau</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_plateau</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">v_plateau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">where_plateau</span><span class="p">]</span>
            <span class="n">t_plateau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_plateau</span><span class="p">]</span>
            <span class="n">v_avg_plateau</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">average_voltage</span><span class="p">(</span><span class="n">v_plateau</span><span class="p">,</span> <span class="n">t_plateau</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;where_plateau&quot;</span><span class="p">:</span> <span class="n">where_plateau</span><span class="p">,</span>
                        <span class="s2">&quot;v_plateau&quot;</span><span class="p">:</span> <span class="n">v_plateau</span><span class="p">,</span>
                        <span class="s2">&quot;t_plateau&quot;</span><span class="p">:</span> <span class="n">t_plateau</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">v_avg_plateau</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_plateau&quot;</span><span class="p">,</span> <span class="s2">&quot;v_plateau&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; interval&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Rebound"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Rebound">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Rebound</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level rebound feature.</span>

<span class="sd">    depends on: v_baseline, stim_end.</span>
<span class="sd">    description: V_max during stimulus_end and stimulus_end + T_rebound - V_baseline.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">T_rebound</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span> <span class="o">=</span> <span class="n">T_rebound</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of T_rebound</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rebound</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_rebound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">):</span>
            <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">where_rebound</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">)</span>
            <span class="n">where_rebound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where_rebound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">v_baseline</span><span class="p">)</span>
            <span class="n">t_rebound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_rebound</span><span class="p">]</span>
            <span class="n">v_rebound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">where_rebound</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_rebound</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># at least 10 time points with rebound</span>
                <span class="n">idx_rebound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">where_rebound</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_baseline</span><span class="p">)</span>
                <span class="n">idx_rebound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">where_rebound</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx_rebound</span><span class="p">]</span>
                <span class="n">max_rebound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">idx_rebound</span><span class="p">]</span>
                <span class="n">rebound</span> <span class="o">=</span> <span class="n">max_rebound</span> <span class="o">-</span> <span class="n">v_baseline</span>
                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;idx_rebound&quot;</span><span class="p">:</span> <span class="n">idx_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;t_rebound&quot;</span><span class="p">:</span> <span class="n">t_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;v_rebound&quot;</span><span class="p">:</span> <span class="n">v_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;v_baseline&quot;</span><span class="p">:</span> <span class="n">v_baseline</span><span class="p">,</span>
                            <span class="s2">&quot;max_rebound&quot;</span><span class="p">:</span> <span class="n">max_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;where_rebound&quot;</span><span class="p">:</span> <span class="n">where_rebound</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">rebound</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_details</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">t_rebound</span><span class="p">,</span> <span class="n">v_rebound</span><span class="p">,</span> <span class="n">idx_rebound</span><span class="p">,</span> <span class="n">v_baseline</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_rebound&quot;</span><span class="p">,</span> <span class="s2">&quot;v_rebound&quot;</span><span class="p">,</span> <span class="s2">&quot;idx_rebound&quot;</span><span class="p">,</span> <span class="s2">&quot;v_baseline&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_rebound</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">idx_rebound</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v_baseline</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_details</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rebound</span><span class="p">,</span> <span class="n">v_rebound</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; interval&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Rebound_APs"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Rebound_APs">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Rebound_APs</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level number of rebounding spikes feature.</span>

<span class="sd">    depends on: stim_end.</span>
<span class="sd">    description: number of spikes during stimulus_end and stimulus_end + T_rebound.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">T_rebound</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span> <span class="o">=</span> <span class="n">T_rebound</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of T_rebound</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">num_rebound_aps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_rebound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">):</span>
            <span class="n">t_spike</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_t&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">idx_spike</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_index&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">v_spike</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_v&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_spike</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
                <span class="n">w_rebound</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">t_spike</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">)</span>
                <span class="n">idx_rebound</span> <span class="o">=</span> <span class="n">idx_spike</span><span class="p">[</span><span class="n">w_rebound</span><span class="p">]</span>
                <span class="n">t_rebound</span> <span class="o">=</span> <span class="n">t_spike</span><span class="p">[</span><span class="n">w_rebound</span><span class="p">]</span>
                <span class="n">v_rebound</span> <span class="o">=</span> <span class="n">v_spike</span><span class="p">[</span><span class="n">w_rebound</span><span class="p">]</span>
                <span class="n">num_rebound_aps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_rebound</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">num_rebound_aps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;idx_rebound&quot;</span><span class="p">:</span> <span class="n">idx_rebound</span><span class="p">,</span>
                                <span class="s2">&quot;t_rebound&quot;</span><span class="p">:</span> <span class="n">t_rebound</span><span class="p">,</span>
                                <span class="s2">&quot;v_rebound&quot;</span><span class="p">:</span> <span class="n">v_rebound</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
        <span class="k">return</span> <span class="n">num_rebound_aps</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t_rebound</span><span class="p">,</span> <span class="n">v_rebound</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_rebound&quot;</span><span class="p">,</span> <span class="s2">&quot;v_rebound&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rebound</span><span class="p">,</span> <span class="n">v_rebound</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Rebound_area"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Rebound_area">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Rebound_area</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level rebound area feature.</span>

<span class="sd">    depends on: v_baseline, stim_end.</span>
<span class="sd">    description: area between rebound curve and baseline voltage from stimulus_end</span>
<span class="sd">    to stimulus_end + T_rebound.</span>
<span class="sd">    units: mV*s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">T_rebound</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span> <span class="o">=</span> <span class="n">T_rebound</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of T_rebound</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rebound_area</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_rebound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">):</span>
            <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">where_rebound</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">)</span>
            <span class="n">where_rebound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where_rebound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">v_baseline</span><span class="p">)</span>
            <span class="n">v_rebound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">where_rebound</span><span class="p">]</span>
            <span class="n">t_rebound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_rebound</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_rebound</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># at least 10 points to integrate</span>
                <span class="n">rebound_area</span> <span class="o">=</span> <span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">v_rebound</span> <span class="o">-</span> <span class="n">v_baseline</span><span class="p">,</span> <span class="n">t_rebound</span><span class="p">)[</span>
                    <span class="o">-</span><span class="mi">1</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;where_rebound&quot;</span><span class="p">:</span> <span class="n">where_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;t_rebound&quot;</span><span class="p">:</span> <span class="n">t_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;v_rebound&quot;</span><span class="p">:</span> <span class="n">v_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;v_baseline&quot;</span><span class="p">:</span> <span class="n">v_baseline</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">rebound_area</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span>
        <span class="n">v_baseline</span><span class="p">,</span> <span class="n">where_rebound</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="s2">&quot;where_rebound&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v_baseline</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where_rebound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Rebound_latency"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Rebound_latency">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Rebound_latency</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level rebound latency feature.</span>

<span class="sd">    depends on: v_baseline, stim_end.</span>
<span class="sd">    description: duration from stimulus_end to when the voltage reaches above</span>
<span class="sd">    baseline for the first time. t_rebound = t_off + rebound_latency.</span>
<span class="sd">    units: s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">T_rebound</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span> <span class="o">=</span> <span class="n">T_rebound</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of T_rebound</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rebound_latency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_rebound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">):</span>
            <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">where_rebound</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">)</span>
            <span class="n">where_rebound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where_rebound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">v_baseline</span><span class="p">)</span>
            <span class="n">t_rebound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_rebound</span><span class="p">]</span>
            <span class="n">v_rebound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">where_rebound</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_rebound</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># at least 10 time points with rebound</span>
                <span class="n">idx_rebound_reached</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">where_rebound</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">t_rebound_reached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_rebound_reached</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rebound_latency</span> <span class="o">=</span> <span class="n">t_rebound_reached</span> <span class="o">-</span> <span class="n">end</span>
                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;idx_rebound_reached&quot;</span><span class="p">:</span> <span class="n">idx_rebound_reached</span><span class="p">,</span>
                            <span class="s2">&quot;t_rebound_reached&quot;</span><span class="p">:</span> <span class="n">t_rebound_reached</span><span class="p">,</span>
                            <span class="s2">&quot;where_rebound&quot;</span><span class="p">:</span> <span class="n">where_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;t_rebound&quot;</span><span class="p">:</span> <span class="n">t_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;v_rebound&quot;</span><span class="p">:</span> <span class="n">v_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;v_baseline&quot;</span><span class="p">:</span> <span class="n">v_baseline</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">rebound_latency</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span>
        <span class="n">t_rebound_reached</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="s2">&quot;t_rebound_reached&quot;</span><span class="p">)</span>
        <span class="n">stim_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stim_end</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="s2">&quot;idx_end&quot;</span><span class="p">)</span>
        <span class="n">until_rebound</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">end_idx</span><span class="p">],</span> <span class="n">t_rebound_reached</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">end_idx</span><span class="p">],</span> <span class="n">where</span><span class="o">=</span><span class="n">until_rebound</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Rebound_avg"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Rebound_avg">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Rebound_avg</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level average rebound feature.</span>

<span class="sd">    depends on: v_baseline, stim_end.</span>
<span class="sd">    description: average voltage between stimulus_end</span>
<span class="sd">    and stimulus_end + T_rebound - baseline voltage.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">T_rebound</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span> <span class="o">=</span> <span class="n">T_rebound</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of T_rebound</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">v_rebound_avg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_rebound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">):</span>
            <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">where_rebound</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_rebound</span><span class="p">)</span>
            <span class="n">where_rebound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">where_rebound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">v_baseline</span><span class="p">)</span>
            <span class="n">v_rebound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">where_rebound</span><span class="p">]</span>
            <span class="n">t_rebound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">where_rebound</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_rebound</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># at least 10 rebound points</span>
                <span class="n">v_rebound_avg</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">average_voltage</span><span class="p">(</span><span class="n">v_rebound</span><span class="p">,</span> <span class="n">t_rebound</span><span class="p">)</span> <span class="o">-</span> <span class="n">v_baseline</span>
                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;where_rebound&quot;</span><span class="p">:</span> <span class="n">where_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;t_rebound&quot;</span><span class="p">:</span> <span class="n">t_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;v_rebound&quot;</span><span class="p">:</span> <span class="n">v_rebound</span><span class="p">,</span>
                            <span class="s2">&quot;v_baseline&quot;</span><span class="p">:</span> <span class="n">v_baseline</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">v_rebound_avg</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t_rebound</span><span class="p">,</span> <span class="n">v_rebound</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_rebound&quot;</span><span class="p">,</span> <span class="s2">&quot;v_rebound&quot;</span><span class="p">])</span>
        <span class="n">v_baseline</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="s2">&quot;v_baseline&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rebound</span><span class="p">,</span> <span class="n">v_rebound</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; interval&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">v_baseline</span><span class="p">],</span>
            <span class="c1"># np.mean(v_rebound),</span>
            <span class="o">*</span><span class="n">t_rebound</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_V_rest"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_V_rest">[docs]</a><span class="k">class</span> <span class="nc">Sweep_V_rest</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level resting potential feature.</span>

<span class="sd">    depends on: v_baseline, r_input, dc_offset.</span>
<span class="sd">    description: v_rest = v_baseline - r_input*dc_offset.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dc_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dc_offset</span> <span class="o">=</span> <span class="n">dc_offset</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compute_at_init</span> <span class="ow">and</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># because of dc_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">v_rest</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="n">v_baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;v_baseline&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="n">r_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;r_input&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v_rest</span> <span class="o">=</span> <span class="n">v_baseline</span> <span class="o">-</span> <span class="n">r_input</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc_offset</span>
            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;v_baseline&quot;</span><span class="p">:</span> <span class="n">v_baseline</span><span class="p">,</span>
                        <span class="s2">&quot;r_input&quot;</span><span class="p">:</span> <span class="n">r_input</span><span class="p">,</span>
                        <span class="s2">&quot;dc_offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc_offset</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">v_rest</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">r_input</span><span class="p">,</span> <span class="n">dc_offset</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;r_input&quot;</span><span class="p">,</span> <span class="s2">&quot;dc_offset&quot;</span><span class="p">])</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">v</span>
        <span class="n">v</span> <span class="o">-=</span> <span class="n">r_input</span> <span class="o">*</span> <span class="n">dc_offset</span> <span class="o">*</span> <span class="mf">1e-3</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;v(t) - r_in*dc_offset&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Num_bursts"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Num_bursts">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Num_bursts</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level number of bursts feature.</span>

<span class="sd">    depends on: num_ap.</span>
<span class="sd">    description: Number of detected bursts.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">num_bursts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="n">num_ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;num_ap&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_ap</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">has_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">idx_burst</span><span class="p">,</span> <span class="n">idx_burst_start</span><span class="p">,</span> <span class="n">idx_burst_end</span> <span class="o">=</span> <span class="n">get_sweep_burst_metrics</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
            <span class="p">)</span>
            <span class="n">peak_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_t&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">idx_burst</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">t_burst_start</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="n">idx_burst_start</span><span class="p">]</span>
                <span class="n">t_burst_end</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="n">idx_burst_end</span><span class="p">]</span>
                <span class="n">num_bursts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_burst</span><span class="p">)</span>
                <span class="n">num_bursts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">num_bursts</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">num_bursts</span>
                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;idx_burst&quot;</span><span class="p">:</span> <span class="n">idx_burst</span><span class="p">,</span>
                            <span class="s2">&quot;idx_burst_start&quot;</span><span class="p">:</span> <span class="n">idx_burst_start</span><span class="p">,</span>
                            <span class="s2">&quot;idx_burst_end&quot;</span><span class="p">:</span> <span class="n">idx_burst_end</span><span class="p">,</span>
                            <span class="s2">&quot;t_burst_start&quot;</span><span class="p">:</span> <span class="n">t_burst_start</span><span class="p">,</span>
                            <span class="s2">&quot;t_burst_end&quot;</span><span class="p">:</span> <span class="n">t_burst_end</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">num_bursts</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t_burst_start</span><span class="p">,</span> <span class="n">t_burst_end</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_burst_start&quot;</span><span class="p">,</span> <span class="s2">&quot;t_burst_end&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">t_burst_start</span><span class="p">,</span> <span class="n">t_burst_end</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
                <span class="n">t_start</span><span class="p">,</span>
                <span class="n">t_end</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;burst </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Burstiness"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Burstiness">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Burstiness</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level burstiness feature.</span>

<span class="sd">    depends on: num_ap.</span>
<span class="sd">    description: max &quot;burstiness&quot; index across detected bursts.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">max_burstiness</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="n">num_ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;num_ap&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_ap</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">has_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">idx_burst</span><span class="p">,</span> <span class="n">idx_burst_start</span><span class="p">,</span> <span class="n">idx_burst_end</span> <span class="o">=</span> <span class="n">get_sweep_burst_metrics</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
            <span class="p">)</span>
            <span class="n">peak_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_t&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">idx_burst</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">t_burst_start</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="n">idx_burst_start</span><span class="p">]</span>
                <span class="n">t_burst_end</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="n">idx_burst_end</span><span class="p">]</span>
                <span class="n">num_bursts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_burst</span><span class="p">)</span>
                <span class="n">max_burstiness</span> <span class="o">=</span> <span class="n">idx_burst</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">num_bursts</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
                <span class="n">max_burstiness</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_burstiness</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">max_burstiness</span>
                <span class="p">)</span>  <span class="c1"># don&#39;t consider negative burstiness</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;idx_burst&quot;</span><span class="p">:</span> <span class="n">idx_burst</span><span class="p">,</span>
                            <span class="s2">&quot;idx_burst_start&quot;</span><span class="p">:</span> <span class="n">idx_burst_start</span><span class="p">,</span>
                            <span class="s2">&quot;idx_burst_end&quot;</span><span class="p">:</span> <span class="n">idx_burst_end</span><span class="p">,</span>
                            <span class="s2">&quot;t_burst_start&quot;</span><span class="p">:</span> <span class="n">t_burst_start</span><span class="p">,</span>
                            <span class="s2">&quot;t_burst_end&quot;</span><span class="p">:</span> <span class="n">t_burst_end</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">max_burstiness</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">num_bursts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;num_bursts&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">num_bursts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_ISI_adapt"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_ISI_adapt">[docs]</a><span class="k">class</span> <span class="nc">Sweep_ISI_adapt</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level inter-spike-interval (ISI) adaptation index feature.</span>

<span class="sd">    depends on: ISIs.</span>
<span class="sd">    description: /.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">isi_adapt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_spikes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">isi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;isi&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">isi_adapt</span> <span class="o">=</span> <span class="n">isi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">isi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">({</span><span class="s2">&quot;isi&quot;</span><span class="p">:</span> <span class="n">isi</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">isi_adapt</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">plot_isi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">added_spike_features</span><span class="p">[</span><span class="s2">&quot;isi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_isi</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">selected_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">relabel_line</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s2">&quot;isi&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_ISI_adapt_avg"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_ISI_adapt_avg">[docs]</a><span class="k">class</span> <span class="nc">Sweep_ISI_adapt_avg</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level average inter-spike-interval (ISI) adaptation index feature.</span>

<span class="sd">    depends on: ISIs.</span>
<span class="sd">    description: /.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">isi_adapt_avg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_spikes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">isi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;isi&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">isi_changes</span> <span class="o">=</span> <span class="n">isi</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">isi</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">isi_adapt_avg</span> <span class="o">=</span> <span class="n">isi_changes</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">({</span><span class="s2">&quot;isi&quot;</span><span class="p">:</span> <span class="n">isi</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">isi_adapt_avg</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">plot_isi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">added_spike_features</span><span class="p">[</span><span class="s2">&quot;isi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_isi</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">relabel_line</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s2">&quot;isi&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_AP_amp_adapt"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_amp_adapt">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_amp_adapt</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level AP amplitude adaptation index feature.</span>

<span class="sd">    depends on: ap_amp.</span>
<span class="sd">    description: /.</span>
<span class="sd">    units: mV/s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ap_amp_adapt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_spikes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">ap_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;ap_amp&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ap_amp_adapt</span> <span class="o">=</span> <span class="n">ap_amp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">ap_amp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">({</span><span class="s2">&quot;ap_amp&quot;</span><span class="p">:</span> <span class="n">ap_amp</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">ap_amp_adapt</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">plot_ap_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">added_spike_features</span><span class="p">[</span><span class="s2">&quot;ap_amp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_ap_amp</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">selected_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">relabel_line</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s2">&quot;ap_amp&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_AP_amp_adapt_avg"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_amp_adapt_avg">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_amp_adapt_avg</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level average AP amplitude adaptation index feature.</span>

<span class="sd">    depends on: ap_amp.</span>
<span class="sd">    description: /.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ap_amp_adapt_avg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_spikes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">ap_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;ap_amp&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ap_amp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ap_amp_changes</span> <span class="o">=</span> <span class="n">ap_amp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">ap_amp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ap_amp_adapt_avg</span> <span class="o">=</span> <span class="n">ap_amp_changes</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">({</span><span class="s2">&quot;ap_amp&quot;</span><span class="p">:</span> <span class="n">ap_amp</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">ap_amp_adapt_avg</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">plot_ap_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">added_spike_features</span><span class="p">[</span><span class="s2">&quot;ap_amp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_ap_amp</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">relabel_line</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s2">&quot;ap_amp&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_Wildness"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_Wildness">[docs]</a><span class="k">class</span> <span class="nc">Sweep_Wildness</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level wildness feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: Wildness is the number of spikes that occur outside of the stimulus interval.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">num_wild_spikes</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_spikes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_onset&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">peak_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_t&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">peak_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_index&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">peak_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_v&quot;</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
            <span class="n">stim_window</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">peak_t</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

            <span class="n">i_wild_spikes</span> <span class="o">=</span> <span class="n">peak_idx</span><span class="p">[</span><span class="o">~</span><span class="n">stim_window</span><span class="p">]</span>
            <span class="n">t_wild_spikes</span> <span class="o">=</span> <span class="n">peak_t</span><span class="p">[</span><span class="o">~</span><span class="n">stim_window</span><span class="p">]</span>
            <span class="n">v_wild_spikes</span> <span class="o">=</span> <span class="n">peak_v</span><span class="p">[</span><span class="o">~</span><span class="n">stim_window</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_wild_spikes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num_wild_spikes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_wild_spikes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;i_wild_spikes&quot;</span><span class="p">:</span> <span class="n">i_wild_spikes</span><span class="p">,</span>
                            <span class="s2">&quot;t_wild_spikes&quot;</span><span class="p">:</span> <span class="n">t_wild_spikes</span><span class="p">,</span>
                            <span class="s2">&quot;v_wild_spikes&quot;</span><span class="p">:</span> <span class="n">v_wild_spikes</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">num_wild_spikes</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;t_wild_spikes&quot;</span><span class="p">,</span> <span class="s2">&quot;v_wild_spikes&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="APSweepFeature"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.APSweepFeature">[docs]</a><span class="k">class</span> <span class="nc">APSweepFeature</span><span class="p">(</span><span class="n">SweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level AP feature.</span>

<span class="sd">    description: Action potential feature to represent a sweep.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ft_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            ft_name (Optional[str], optional): Name of the spike feature</span>
<span class="sd">            ap_selector (Optional[Callable], optional): Function which selects a</span>
<span class="sd">                representative ap or set of aps based on a given criterion.</span>
<span class="sd">                Function expects a EphysSweepSetFeatureExtractor object as input and</span>
<span class="sd">                returns indices for the selected aps. If none is provided, falls</span>
<span class="sd">                back to selecting all aps.</span>
<span class="sd">            ft_aggregator (Optional[Callable], optional): Function which aggregates</span>
<span class="sd">                a list of feature values into a single value. Function expects a</span>
<span class="sd">                list or ndarray of numbers as input. If none is provided, falls back</span>
<span class="sd">                to `np.nanmedian` (equates to pass through for single sweeps).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ap_selector</span> <span class="o">=</span> <span class="n">ap_selector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft_aggregator</span> <span class="o">=</span> <span class="n">ft_aggregator</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ft_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ft_name</span>

    <span class="k">def</span> <span class="nf">_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function expects a EphysSweepSetFeatureExtractor object as input and</span>
<span class="sd">        returns indices for the selected aps.</span>

<span class="sd">        description: Select a representative ap or set of aps based on a</span>
<span class="sd">        given criterion. If none is provided, falls back to selecting all aps during stimulus.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ap_selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">peak_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="s2">&quot;peak_t&quot;</span><span class="p">)</span>
            <span class="n">onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_onset&quot;</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_sweep_feature</span><span class="p">(</span><span class="s2">&quot;stim_end&quot;</span><span class="p">)</span>
            <span class="n">stim_window</span> <span class="o">=</span> <span class="n">where_between</span><span class="p">(</span><span class="n">peak_t</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stim_window</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ap_selector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function expects a list or ndarray of numbers as input.</span>

<span class="sd">        description: Aggregate a list of feature values into a single value. If none is provided, falls back</span>
<span class="sd">        to `np.nanmedian` (equates to pass through for single sweeps).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft_aggregator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">({</span><span class="s2">&quot;aggregate_idx&quot;</span><span class="p">:</span> <span class="n">median_idx</span><span class="p">(</span><span class="n">X</span><span class="p">)})</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft_aggregator</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_spike_feature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span>
        <span class="n">ft_agg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selected_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">fts_selected</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="n">selected_idx</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fts_selected</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)):</span>
                <span class="n">ft_agg</span> <span class="o">=</span> <span class="n">fts_selected</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fts_selected</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fts_selected</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ft_agg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ft_agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">store_diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagnostics</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;selected_idx&quot;</span><span class="p">:</span> <span class="n">selected_idx</span><span class="p">,</span>
                        <span class="s2">&quot;selected_fts&quot;</span><span class="p">:</span> <span class="n">fts_selected</span><span class="p">,</span>
                        <span class="s2">&quot;selection&quot;</span><span class="p">:</span> <span class="n">parse_desc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">),</span>
                        <span class="s2">&quot;aggregation&quot;</span><span class="p">:</span> <span class="n">parse_desc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">ft_agg</span>

    <span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span> <span class="s2">&quot;selected_idx&quot;</span><span class="p">)</span>
        <span class="n">plot_spike_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">added_spike_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_spike_feature</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">selected_idxs</span><span class="o">=</span><span class="n">idxs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Sweep_AP_AHP"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_AHP">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_AHP</span><span class="p">(</span><span class="n">APSweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level Afterhyperpolarization feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: Afterhyperpolarization (AHP) for representative AP. Difference</span>
<span class="sd">    between the fast trough and the threshold.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="s2">&quot;ap_ahp&quot;</span><span class="p">,</span> <span class="n">ap_selector</span><span class="p">,</span> <span class="n">ft_aggregator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Sweep_AP_ADP"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_ADP">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_ADP</span><span class="p">(</span><span class="n">APSweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level Afterdepolarization feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: Afterdepolarization (ADP) for representative AP. Difference between the ADP and the fast trough.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="s2">&quot;ap_adp&quot;</span><span class="p">,</span> <span class="n">ap_selector</span><span class="p">,</span> <span class="n">ft_aggregator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Sweep_AP_thresh"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_thresh">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_thresh</span><span class="p">(</span><span class="n">APSweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level AP threshold feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: AP threshold for representative AP.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="s2">&quot;ap_thresh&quot;</span><span class="p">,</span> <span class="n">ap_selector</span><span class="p">,</span> <span class="n">ft_aggregator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Sweep_AP_amp"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_amp">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_amp</span><span class="p">(</span><span class="n">APSweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level AP amplitude feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: AP amplitude for representative AP.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="s2">&quot;ap_amp&quot;</span><span class="p">,</span> <span class="n">ap_selector</span><span class="p">,</span> <span class="n">ft_aggregator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Sweep_AP_width"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_width">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_width</span><span class="p">(</span><span class="n">APSweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level AP width feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: AP width for representative AP.</span>
<span class="sd">    units: s.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="s2">&quot;ap_width&quot;</span><span class="p">,</span> <span class="n">ap_selector</span><span class="p">,</span> <span class="n">ft_aggregator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Sweep_AP_peak"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_peak">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_peak</span><span class="p">(</span><span class="n">APSweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level AP peak feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: AP peak for representative AP.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="s2">&quot;ap_peak&quot;</span><span class="p">,</span> <span class="n">ap_selector</span><span class="p">,</span> <span class="n">ft_aggregator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Sweep_AP_trough"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_trough">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_trough</span><span class="p">(</span><span class="n">APSweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level AP trough feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: AP trough for representative AP.</span>
<span class="sd">    units: mV.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="s2">&quot;ap_trough&quot;</span><span class="p">,</span> <span class="n">ap_selector</span><span class="p">,</span> <span class="n">ft_aggregator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Sweep_AP_UDR"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_AP_UDR">[docs]</a><span class="k">class</span> <span class="nc">Sweep_AP_UDR</span><span class="p">(</span><span class="n">APSweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level Upstroke-to-downstroke ratio feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: Upstroke-to-downstroke ratio for representative AP.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="s2">&quot;ap_udr&quot;</span><span class="p">,</span> <span class="n">ap_selector</span><span class="p">,</span> <span class="n">ft_aggregator</span><span class="p">)</span></div>


<div class="viewcode-block" id="Sweep_ISI"><a class="viewcode-back" href="../../../ephyspy.features.html#ephyspy.features.sweep_features.Sweep_ISI">[docs]</a><span class="k">class</span> <span class="nc">Sweep_ISI</span><span class="p">(</span><span class="n">APSweepFeature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sweep level ISI ratio feature.</span>

<span class="sd">    depends on: /.</span>
<span class="sd">    description: Median interspike interval.</span>
<span class="sd">    units: /.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_at_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ap_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ft_aggregator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">compute_at_init</span><span class="p">,</span> <span class="s2">&quot;isi&quot;</span><span class="p">,</span> <span class="n">ap_selector</span><span class="p">,</span> <span class="n">ft_aggregator</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Jonas Beck.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>